###############################################################################
# Wolf config.toml — 3DS Dual-Screen Streaming PoC
#
# Placed at /etc/wolf/cfg/config.toml on the VM.
#
# Dual-screen architecture:
#   "Azahar 3DS (Dual Screen)" — Primary app that launches the emulator in
#     SeparateWindows mode (layout_option=4). Azahar creates two SDL windows.
#     Our custom gst-wayland-display routes each window to a separate output:
#       Window 1 (top screen) → primary space → primary video stream
#       Window 2 (bottom screen) → secondary space → secondary_video interpipe
#
#   "Azahar 3DS (Bottom Screen)" — Lightweight secondary app for the 2nd
#     Moonlight client. No compositor, no Docker container — just reads the
#     secondary_video interpipe sink that was auto-spawned by the primary.
#
#   "Azahar 3DS (Single Screen)" — Traditional single-screen for testing.
#   "Azahar 3DS (Settings)" — No ROM, windowed, for config changes.
#
# Setup:
#   1. Start Wolf with GST_WD_MULTI_OUTPUT=1 GST_WD_SECONDARY_SINK_NAME=secondary_video
#   2. Client 1 (iPad) pairs and launches "Azahar 3DS (Dual Screen)" → top screen
#   3. Client 2 (iPhone) pairs and launches "Azahar 3DS (Bottom Screen)" → bottom screen
###############################################################################

hostname = "gamer-vm"
config_version = 2
support_hevc = true

###############################################################################
# Profile: 3DS Gaming
###############################################################################
[[profiles]]
id = "3ds-gaming"

# ── Dual Screen: Primary (Top Screen) ─────────────────────────────────────
# Launches Azahar with SeparateWindows mode. The custom gst-wayland-display
# auto-spawns a secondary pipeline that feeds "secondary_video" interpipe.
[[profiles.apps]]
title = "Azahar 3DS (Dual Screen)"
start_virtual_compositor = true
start_audio_server = true

[profiles.apps.runner]
type = "docker"
name = "GamerAzaharDual"
image = "gamer/azahar:poc"
mounts = [
    "/home/gamer/roms:/home/retro/roms:ro",
    "/home/gamer/saves:/home/retro/saves:rw",
    "/home/gamer/config:/home/retro/config:rw",
    "/home/gamer/firmware:/home/retro/firmware:ro",
]
env = [
    "ROM_FILENAME=pokemon-alpha-sapphire.3ds",
    # SeparateWindows mode — Azahar creates two windows
    "LAYOUT_OPTION=4",
    # Don't fullscreen — let compositor handle window placement
    "AZAHAR_FULLSCREEN=0",
    "RUN_SWAY=0",
    "NVIDIA_DRIVER_CAPABILITIES=all",
    "NVIDIA_VISIBLE_DEVICES=all",
    "GOW_REQUIRED_DEVICES=/dev/input/event* /dev/dri/* /dev/nvidia*",
]
devices = []
ports = []
base_create_json = """
{
    "ReadonlyRootfs": false,
    "HostConfig": {
        "Runtime": "nvidia",
        "IpcMode": "host",
        "NetworkMode": "host",
        "ReadonlyRootfs": false,
        "CapAdd": ["SYS_ADMIN", "NET_RAW", "NET_ADMIN", "MKNOD", "SYS_NICE"],
        "DeviceCgroupRules": ["c 13:* rmw", "c 244:* rmw"]
    }
}
"""

# ── Dual Screen: Secondary (Bottom Screen) ────────────────────────────────
# Video-only app — no compositor, no Docker container.
# Reads from the "secondary_video" interpipe that was auto-spawned by the
# primary Azahar app above. Connect a second Moonlight client to this.
[[profiles.apps]]
title = "Azahar 3DS (Bottom Screen)"
start_virtual_compositor = false
start_audio_server = false

[profiles.apps.video]
source = "interpipesrc listen-to=secondary_video is-live=true stream-sync=restart-ts max-bytes=0 max-buffers=1 leaky-type=downstream"

# ── Single Screen Mode ──────────────────────────────────────────────────────
# Top screen only, fullscreen — traditional single-stream gameplay.
[[profiles.apps]]
title = "Azahar 3DS (Single Screen)"
start_virtual_compositor = true
start_audio_server = true

[profiles.apps.runner]
type = "docker"
name = "GamerAzahar"
image = "gamer/azahar:poc"
mounts = [
    "/home/gamer/roms:/home/retro/roms:ro",
    "/home/gamer/saves:/home/retro/saves:rw",
    "/home/gamer/config:/home/retro/config:rw",
    "/home/gamer/firmware:/home/retro/firmware:ro",
]
env = [
    "ROM_FILENAME=pokemon-alpha-sapphire.3ds",
    # SingleScreen — top screen only, fullscreen
    "LAYOUT_OPTION=1",
    "AZAHAR_FULLSCREEN=1",
    "RUN_SWAY=0",
    "NVIDIA_DRIVER_CAPABILITIES=all",
    "NVIDIA_VISIBLE_DEVICES=all",
    "GOW_REQUIRED_DEVICES=/dev/input/event* /dev/dri/* /dev/nvidia*",
]
devices = []
ports = []
base_create_json = """
{
    "ReadonlyRootfs": false,
    "HostConfig": {
        "Runtime": "nvidia",
        "IpcMode": "host",
        "NetworkMode": "host",
        "ReadonlyRootfs": false,
        "CapAdd": ["SYS_ADMIN", "NET_RAW", "NET_ADMIN", "MKNOD", "SYS_NICE"],
        "DeviceCgroupRules": ["c 13:* rmw", "c 244:* rmw"]
    }
}
"""

# ── Settings Mode ────────────────────────────────────────────────────────────
# No ROM, windowed — for adjusting Azahar config via the menu.
[[profiles.apps]]
title = "Azahar 3DS (Settings)"
start_virtual_compositor = true
start_audio_server = true

[profiles.apps.runner]
type = "docker"
name = "GamerAzaharSettings"
image = "gamer/azahar:poc"
mounts = [
    "/home/gamer/roms:/home/retro/roms:ro",
    "/home/gamer/saves:/home/retro/saves:rw",
    "/home/gamer/config:/home/retro/config:rw",
    "/home/gamer/firmware:/home/retro/firmware:ro",
]
env = [
    "ROM_OPTIONAL=1",
    "AZAHAR_FULLSCREEN=0",
    "RUN_SWAY=0",
    "NVIDIA_DRIVER_CAPABILITIES=all",
    "NVIDIA_VISIBLE_DEVICES=all",
    "GOW_REQUIRED_DEVICES=/dev/input/event* /dev/dri/* /dev/nvidia*",
]
devices = []
ports = []
base_create_json = """
{
    "ReadonlyRootfs": false,
    "HostConfig": {
        "Runtime": "nvidia",
        "IpcMode": "host",
        "NetworkMode": "host",
        "ReadonlyRootfs": false,
        "CapAdd": ["SYS_ADMIN", "NET_RAW", "NET_ADMIN", "MKNOD", "SYS_NICE"],
        "DeviceCgroupRules": ["c 13:* rmw", "c 244:* rmw"]
    }
}
"""
