###############################################################################
# Wolf config.toml — 3DS Dual-Screen Streaming PoC
#
# Placed at /etc/wolf/cfg/config.toml on the VM.
#
# Dual-screen architecture:
#   "Azahar 3DS (Dual Screen)" — Primary app that launches the emulator in
#     SeparateWindows mode (layout_option=4). Azahar creates two SDL windows.
#     Our custom gst-wayland-display routes each window to a separate output:
#       Window 1 (top screen) → primary space → primary video stream
#       Window 2 (bottom screen) → secondary space → waylanddisplaysecondary source
#
#   "Azahar 3DS (Bottom Screen)" — Lightweight secondary app for the 2nd
#     Moonlight client. No compositor, no Docker container — just reads the
#     secondary_video interpipe sink that was auto-spawned by the primary.
#
#   "Azahar 3DS (Single Screen)" — Traditional single-screen for testing.
#   "Azahar 3DS (Settings)" — No ROM, windowed, for config changes.
#
# Setup:
#   1. Start Wolf with GST_WD_MULTI_OUTPUT=1
#   2. Client 1 (iPad) pairs and launches "Azahar 3DS (Dual Screen)" → top screen
#   3. Client 2 (iPhone) pairs and launches "Azahar 3DS (Bottom Screen)" → bottom screen
###############################################################################

hostname = "gamer-vm"
config_version = 2
support_hevc = true

###############################################################################
# Profile: 3DS Gaming
###############################################################################
[[profiles]]
id = "moonlight-profile-id"

# ── Dual Screen: Primary (Top Screen) ─────────────────────────────────────
# Launches Azahar with SeparateWindows mode. The custom gst-wayland-display
# routes Azahar's second window to a secondary compositor output.
[[profiles.apps]]
title = "Azahar 3DS (Dual Screen)"
start_virtual_compositor = true
start_audio_server = true

[profiles.apps.runner]
type = "docker"
name = "GamerAzaharDual"
image = "gamer/azahar:poc"
mounts = [
    "/home/gamer/roms:/home/retro/roms:ro",
    "/home/gamer/saves:/home/retro/saves:rw",
    "/home/gamer/config:/home/retro/config:rw",
    "/home/gamer/firmware:/home/retro/firmware:ro",
]
env = [
    "ROM_FILENAME=pokemon-alpha-sapphire.3ds",
    # SeparateWindows mode — Azahar creates two windows
    "LAYOUT_OPTION=4",
    # Don't fullscreen — let compositor handle window placement
    "AZAHAR_FULLSCREEN=0",
    # IMPORTANT: Disable nested compositors so Wolf's waylanddisplaysrc
    # sees Azahar's windows directly as separate Wayland surfaces.
    "RUN_GAMESCOPE=0",
    "RUN_SWAY=0",
    "NVIDIA_DRIVER_CAPABILITIES=all",
    "NVIDIA_VISIBLE_DEVICES=all",
    "GOW_REQUIRED_DEVICES=/dev/input/event* /dev/dri/* /dev/nvidia*",
]
devices = []
ports = []
base_create_json = """
{
    "ReadonlyRootfs": false,
    "HostConfig": {
        "Runtime": "nvidia",
        "IpcMode": "host",
        "NetworkMode": "host",
        "ReadonlyRootfs": false,
        "CapAdd": ["SYS_ADMIN", "NET_RAW", "NET_ADMIN", "MKNOD", "SYS_NICE"],
        "DeviceCgroupRules": ["c 13:* rmw", "c 244:* rmw"]
    }
}
"""

# ── Dual Screen: Secondary (Bottom Screen) ────────────────────────────────
# Video-only app — no compositor, no Docker container.
# Reads from the `secondary_video` interpipe sink emitted by our custom
# gst-wayland-display fork in the primary app session.
[[profiles.apps]]
title = "Azahar 3DS (Bottom Screen)"
start_virtual_compositor = false
start_audio_server = false

[profiles.apps.runner]
# Keep a lightweight process alive so Wolf's process runner has a valid command.
# Without this, some Wolf builds materialize an empty process runner and fail with:
# "execve failed: Permission denied", which causes RTSP handshake failures.
type = "process"
run_cmd = "/etc/wolf/cfg/bottom-screen-keepalive.sh"

[profiles.apps.video]
# NOTE: Use interpipesrc here (not waylanddisplaysecondary directly).
# The direct waylanddisplaysecondary path can negotiate non-CUDA buffers and
# break the NVENC path with "Input buffer is not CUDA".
source = "interpipesrc listen-to=secondary_video is-live=true stream-sync=restart-ts max-bytes=0 max-buffers=1 block=false ! queue max-size-buffers=8 leaky=downstream"

[profiles.apps.audio]
# Keep Moonlight session audio lane alive for this video-only app.
# Prevents session teardown from missing/empty {session_id}_audio sources.
source = "audiotestsrc is-live=true wave=silence"

# ── Single Screen Mode ──────────────────────────────────────────────────────
# Top screen only, fullscreen — traditional single-stream gameplay.
[[profiles.apps]]
title = "Azahar 3DS (Single Screen)"
start_virtual_compositor = true
start_audio_server = true

[profiles.apps.runner]
type = "docker"
name = "GamerAzahar"
image = "gamer/azahar:poc"
mounts = [
    "/home/gamer/roms:/home/retro/roms:ro",
    "/home/gamer/saves:/home/retro/saves:rw",
    "/home/gamer/config:/home/retro/config:rw",
    "/home/gamer/firmware:/home/retro/firmware:ro",
]
env = [
    "ROM_FILENAME=pokemon-alpha-sapphire.3ds",
    # SingleScreen — top screen only, fullscreen
    "LAYOUT_OPTION=1",
    "AZAHAR_FULLSCREEN=1",
    # Single-screen benefits from Sway window management for fullscreen toggles.
    "RUN_SWAY=1",
    "NVIDIA_DRIVER_CAPABILITIES=all",
    "NVIDIA_VISIBLE_DEVICES=all",
    "GOW_REQUIRED_DEVICES=/dev/input/event* /dev/dri/* /dev/nvidia*",
]
devices = []
ports = []
base_create_json = """
{
    "ReadonlyRootfs": false,
    "HostConfig": {
        "Runtime": "nvidia",
        "IpcMode": "host",
        "NetworkMode": "host",
        "ReadonlyRootfs": false,
        "CapAdd": ["SYS_ADMIN", "NET_RAW", "NET_ADMIN", "MKNOD", "SYS_NICE"],
        "DeviceCgroupRules": ["c 13:* rmw", "c 244:* rmw"]
    }
}
"""

# ── Settings Mode ────────────────────────────────────────────────────────────
# No ROM, windowed — for adjusting Azahar config via the menu.
[[profiles.apps]]
title = "Azahar 3DS (Settings)"
start_virtual_compositor = true
start_audio_server = true

[profiles.apps.runner]
type = "docker"
name = "GamerAzaharSettings"
image = "gamer/azahar:poc"
mounts = [
    "/home/gamer/roms:/home/retro/roms:ro",
    "/home/gamer/saves:/home/retro/saves:rw",
    "/home/gamer/config:/home/retro/config:rw",
    "/home/gamer/firmware:/home/retro/firmware:ro",
]
env = [
    "ROM_OPTIONAL=1",
    "AZAHAR_FULLSCREEN=0",
    # Keep unset to launch directly without nested compositor.
    "NVIDIA_DRIVER_CAPABILITIES=all",
    "NVIDIA_VISIBLE_DEVICES=all",
    "GOW_REQUIRED_DEVICES=/dev/input/event* /dev/dri/* /dev/nvidia*",
]
devices = []
ports = []
base_create_json = """
{
    "ReadonlyRootfs": false,
    "HostConfig": {
        "Runtime": "nvidia",
        "IpcMode": "host",
        "NetworkMode": "host",
        "ReadonlyRootfs": false,
        "CapAdd": ["SYS_ADMIN", "NET_RAW", "NET_ADMIN", "MKNOD", "SYS_NICE"],
        "DeviceCgroupRules": ["c 13:* rmw", "c 244:* rmw"]
    }
}
"""
