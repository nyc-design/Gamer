###############################################################################
# Wolf config.toml — 3DS Dual-Screen Streaming PoC
#
# Placed at /etc/wolf/cfg/config.toml on the VM.
#
# App modes:
#   "Azahar 3DS (Dual Screen)" — SeparateWindows mode (layout_option=4)
#     Azahar creates two SDL windows (top + bottom screen).
#     Sway tiles them side-by-side in one compositor output.
#     This validates the foundation for per-window stream splitting.
#
#   "Azahar 3DS (Single Screen)" — Top screen only (layout_option=1)
#     Traditional single-screen mode for gameplay-focused testing.
#
#   "Azahar 3DS (Settings)" — No ROM, windowed, for config changes.
#
# Dual-screen architecture goal (requires Wolf source changes):
#   Each SDL window → separate Wayland output → separate stream → separate
#   Moonlight app. See PR spec: Session Group + Stream Source Selection.
###############################################################################

hostname = "gamer-vm"
config_version = 2
support_hevc = true

###############################################################################
# Profile: 3DS Gaming
###############################################################################
[[profiles]]
id = "3ds-gaming"

# ── Dual Screen Mode ────────────────────────────────────────────────────────
# Azahar SeparateWindows: two SDL windows tiled by Sway in one stream.
# Tests that Azahar correctly creates two independent Wayland surfaces.
[[profiles.apps]]
title = "Azahar 3DS (Dual Screen)"
start_virtual_compositor = true
start_audio_server = true

[profiles.apps.runner]
type = "docker"
name = "GamerAzaharDual"
image = "gamer/azahar:poc"
mounts = [
    "/home/gamer/roms:/home/retro/roms:ro",
    "/home/gamer/saves:/home/retro/saves:rw",
    "/home/gamer/config:/home/retro/config:rw",
    "/home/gamer/firmware:/home/retro/firmware:ro",
]
env = [
    "ROM_FILENAME=pokemon-alpha-sapphire.3ds",
    # SeparateWindows mode — Azahar creates two windows
    "LAYOUT_OPTION=4",
    # Don't fullscreen — let Sway tile both windows
    "AZAHAR_FULLSCREEN=0",
    "RUN_SWAY=1",
    "NVIDIA_DRIVER_CAPABILITIES=all",
    "NVIDIA_VISIBLE_DEVICES=all",
    "GOW_REQUIRED_DEVICES=/dev/input/event* /dev/dri/* /dev/nvidia*",
]
devices = []
ports = []
base_create_json = """
{
    "ReadonlyRootfs": false,
    "HostConfig": {
        "Runtime": "nvidia",
        "IpcMode": "host",
        "NetworkMode": "host",
        "ReadonlyRootfs": false,
        "CapAdd": ["SYS_ADMIN", "NET_RAW", "NET_ADMIN", "MKNOD", "SYS_NICE"],
        "DeviceCgroupRules": ["c 13:* rmw", "c 244:* rmw"]
    }
}
"""

# ── Single Screen Mode ──────────────────────────────────────────────────────
# Top screen only, fullscreen — traditional single-stream gameplay.
[[profiles.apps]]
title = "Azahar 3DS (Single Screen)"
start_virtual_compositor = true
start_audio_server = true

[profiles.apps.runner]
type = "docker"
name = "GamerAzahar"
image = "gamer/azahar:poc"
mounts = [
    "/home/gamer/roms:/home/retro/roms:ro",
    "/home/gamer/saves:/home/retro/saves:rw",
    "/home/gamer/config:/home/retro/config:rw",
    "/home/gamer/firmware:/home/retro/firmware:ro",
]
env = [
    "ROM_FILENAME=pokemon-alpha-sapphire.3ds",
    # SingleScreen — top screen only, fullscreen
    "LAYOUT_OPTION=1",
    "AZAHAR_FULLSCREEN=1",
    "RUN_SWAY=1",
    "NVIDIA_DRIVER_CAPABILITIES=all",
    "NVIDIA_VISIBLE_DEVICES=all",
    "GOW_REQUIRED_DEVICES=/dev/input/event* /dev/dri/* /dev/nvidia*",
]
devices = []
ports = []
base_create_json = """
{
    "ReadonlyRootfs": false,
    "HostConfig": {
        "Runtime": "nvidia",
        "IpcMode": "host",
        "NetworkMode": "host",
        "ReadonlyRootfs": false,
        "CapAdd": ["SYS_ADMIN", "NET_RAW", "NET_ADMIN", "MKNOD", "SYS_NICE"],
        "DeviceCgroupRules": ["c 13:* rmw", "c 244:* rmw"]
    }
}
"""

# ── Settings Mode ────────────────────────────────────────────────────────────
# No ROM, windowed — for adjusting Azahar config via the menu.
[[profiles.apps]]
title = "Azahar 3DS (Settings)"
start_virtual_compositor = true
start_audio_server = true

[profiles.apps.runner]
type = "docker"
name = "GamerAzaharSettings"
image = "gamer/azahar:poc"
mounts = [
    "/home/gamer/roms:/home/retro/roms:ro",
    "/home/gamer/saves:/home/retro/saves:rw",
    "/home/gamer/config:/home/retro/config:rw",
    "/home/gamer/firmware:/home/retro/firmware:ro",
]
env = [
    "ROM_OPTIONAL=1",
    "AZAHAR_FULLSCREEN=0",
    "RUN_SWAY=1",
    "NVIDIA_DRIVER_CAPABILITIES=all",
    "NVIDIA_VISIBLE_DEVICES=all",
    "GOW_REQUIRED_DEVICES=/dev/input/event* /dev/dri/* /dev/nvidia*",
]
devices = []
ports = []
base_create_json = """
{
    "ReadonlyRootfs": false,
    "HostConfig": {
        "Runtime": "nvidia",
        "IpcMode": "host",
        "NetworkMode": "host",
        "ReadonlyRootfs": false,
        "CapAdd": ["SYS_ADMIN", "NET_RAW", "NET_ADMIN", "MKNOD", "SYS_NICE"],
        "DeviceCgroupRules": ["c 13:* rmw", "c 244:* rmw"]
    }
}
"""
