###############################################################################
# Gaming VM Docker Compose — PoC for 3DS Streaming
#
# Runs on a GPU VM (TensorDock, GCP, or any machine with NVIDIA GPU).
# Wolf handles Moonlight protocol, video encoding, and spawns the Azahar
# container when a user connects.
#
# Prerequisites on the host:
#   - NVIDIA GPU with driver installed
#   - Docker + NVIDIA Container Toolkit
#   - Ports 47984-48010 open (Moonlight protocol)
#   - ROMs placed in ~/roms/
#
# Usage:
#   docker compose build
#   docker compose up -d
#   # Then pair your iPhone Moonlight app to the VM's IP
###############################################################################

services:
  ###########################################################################
  # Wolf — Moonlight-compatible streaming server
  #
  # Handles: RTSP/RTP streaming, NVENC video encoding, PulseAudio capture,
  # virtual input devices (gamepad, touch), Docker app orchestration.
  #
  # When a Moonlight client connects and selects "Azahar 3DS", Wolf spawns
  # the azahar container with the correct GPU, audio, and display access.
  ###########################################################################
  wolf:
    image: ghcr.io/games-on-whales/wolf:stable
    environment:
      # Use nvidia driver volume approach (per Wolf docs) — Wolf mounts this
      # volume into spawned app containers for GPU access
      - NVIDIA_DRIVER_VOLUME_NAME=nvidia-driver-vol
      - WOLF_RENDER_NODE=/dev/dri/renderD128
      # Where Wolf stores config and app state
      - HOST_APPS_STATE_FOLDER=/etc/wolf
      - WOLF_LOG_LEVEL=INFO
      # XDG_RUNTIME_DIR for PulseAudio and Wayland sockets
      - XDG_RUNTIME_DIR=/tmp/sockets
    volumes:
      # Wolf state directory — contains cfg/config.toml, keys, app state
      # We mount the entire wolf/ dir so Wolf can rename/migrate config files
      - ./wolf:/etc/wolf/cfg
      # Wolf needs Docker socket to spawn app containers
      - /var/run/docker.sock:/var/run/docker.sock:rw
      # Device access for GPU, input, and udev
      - /dev/:/dev/:rw
      - /run/udev:/run/udev:rw
      # NVIDIA driver volume — pre-populated with host's nvidia driver libs
      - nvidia-driver-vol:/usr/nvidia:rw
    device_cgroup_rules:
      - 'c 13:* rmw'    # Input devices
      - 'c 244:* rmw'   # NVIDIA devices
    devices:
      - /dev/dri         # GPU render nodes
      - /dev/uinput      # Virtual input device creation
      - /dev/udmabuf     # DMA buffer allocation for Wayland compositor
      - /dev/nvidia-uvm
      - /dev/nvidia-uvm-tools
      - /dev/nvidia-caps/nvidia-cap1
      - /dev/nvidia-caps/nvidia-cap2
      - /dev/nvidiactl
      - /dev/nvidia0
      - /dev/nvidia-modeset
    network_mode: host
    restart: unless-stopped

  ###########################################################################
  # Azahar 3DS Emulator — pre-built image
  #
  # This is NOT started by docker compose. Wolf spawns it on-demand when
  # a Moonlight client selects the "Azahar 3DS" app (defined in config.toml).
  #
  # We define it here only so `docker compose build` builds the image
  # and tags it as "gamer/azahar:poc" which the Wolf config references.
  ###########################################################################
  azahar:
    build:
      context: ./azahar
      dockerfile: Dockerfile
    image: gamer/azahar:poc
    # This container is managed by Wolf, not by compose.
    # Setting profiles prevents `docker compose up` from starting it directly.
    profiles:
      - build-only

volumes:
  nvidia-driver-vol:
    external: true
